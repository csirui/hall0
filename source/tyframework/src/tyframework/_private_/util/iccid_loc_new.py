# coding: utf-8
# fanzheng 2014/9/27 CMCC
# dingfu 2015/8/4 add CUC/CTC
# 20150804: based on iccids collected in the log, of all reported iccids, 25%
# are invalid. 70% can be located (accuracy is still unknown). The rest are
# missing in the mapping table, either missing operator id (0.5%) or
# province id (4.5%).

import re


class IccidLoc(object):
    def __call__(self, *argl, **argd):
        return self

    def _init_ctx_(self):
        from tyframework.context import TyContext
        self.__ctx__ = TyContext

    def __init__(self):
        self.prov2pc_map = {
            '北京': 10,
            '上海': 20,
            '天津': 30,
            '重庆': 40,
            '内蒙古': 1,
            '山西': 3,
            '河北': 5,
            '辽宁': 11,
            '吉林': 13,
            '黑龙江': 15,
            '江苏': 21,
            '安徽': 23,
            '山东': 25,
            '浙江': 31,
            '江西': 33,
            '福建': 35,
            '湖南': 41,
            '湖北': 43,
            '河南': 45,
            '广东': 51,
            '广西': 53,
            '贵州': 55,
            '海南': 57,
            '四川': 61,
            '云南': 65,
            '陕西': 71,
            '甘肃': 73,
            '宁夏': 75,
            '青海': 81,
            '新疆': 83,
            '西藏': 85,
            '香港': -1,
            '澳门': -1,
            '台湾': -1,
            # '香港' : 999077,
            # '澳门' : 999078,
            # '台湾' : 86,
        }
        self.iccid2prov_map = {
            '00': {
                '01': "北京",
                '02': "天津",
                '03': "河北",
                '04': "山西",
                '05': "内蒙古",
                '06': "辽宁",
                '07': "吉林",
                '08': "黑龙江",
                '09': "上海",
                '10': "江苏",
                '11': "浙江",
                '12': "安徽",
                '13': "福建",
                '14': "江西",
                '15': "山东",
                '16': "河南",
                '17': "湖北",
                '18': "湖南",
                '19': "广东",
                '20': "广西",
                '21': "海南",
                '22': "四川",
                '23': "贵州",
                '24': "云南",
                '25': "西藏",
                '26': "陕西",
                '27': "甘肃",
                '28': "青海",
                '29': "宁夏",
                '30': "新疆",
                '31': "重庆",
            },
            '01': {
                '10': "内蒙古",
                '11': "北京",
                '13': "天津",
                '17': "山东",
                '18': "河北",
                '19': "山西",
                '30': "安徽",
                '31': "上海",
                '34': "江苏",
                '36': "浙江",
                '38': "福建",
                '50': "海南",
                '51': "广东",
                '59': "广西",
                '70': "青海",
                '71': "湖北",
                '74': "湖南",
                '75': "江西",
                '76': "河南",
                '79': "西藏",
                '81': "四川",
                '83': "重庆",
                '84': "陕西",
                '85': "贵州",
                '86': "云南",
                '87': "甘肃",
                '88': "宁夏",
                '89': "新疆",
                '90': "吉林",
                '91': "辽宁",
                '97': "黑龙江",
            },
            '03': {
                "551": "安徽",
                "559": "安徽",
                "557": "安徽",
                "563": "安徽",
                "553": "安徽",
                "552": "安徽",
                "562": "安徽",
                "558": "安徽",
                "555": "安徽",
                "565": "安徽",
                "561": "安徽",
                "556": "安徽",
                "564": "安徽",
                "554": "安徽",
                "550": "安徽",
                "010": "北京",
                "023": "重庆",
                "591": "福建",
                "599": "福建",
                "592": "福建",
                "595": "福建",
                "597": "福建",
                "598": "福建",
                "594": "福建",
                "596": "福建",
                "593": "福建",
                "930": "甘肃",
                "931": "甘肃",
                "932": "甘肃",
                "936": "甘肃",
                "937": "甘肃",
                "935": "甘肃",
                "933": "甘肃",
                "943": "甘肃",
                "938": "甘肃",
                "934": "甘肃",
                "020": "广东",
                "769": "广东",
                "753": "广东",
                "768": "广东",
                "660": "广东",
                "755": "广东",
                "668": "广东",
                "757": "广东",
                "750": "广东",
                "763": "广东",
                "751": "广东",
                "754": "广东",
                "752": "广东",
                "762": "广东",
                "759": "广东",
                "758": "广东",
                "760": "广东",
                "662": "广东",
                "771": "广西",
                "776": "广西",
                "779": "广西",
                "773": "广西",
                "772": "广西",
                "778": "广西",
                "777": "广西",
                "775": "广西",
                "774": "广西",
                "851": "贵州",
                "856": "贵州",
                "854": "贵州",
                "859": "贵州",
                "852": "贵州",
                "858": "贵州",
                "855": "贵州",
                "853": "贵州",
                "857": "贵州",
                "898": "海南",
                "311": "河北",
                "319": "河北",
                "310": "河北",
                "317": "河北",
                "315": "河北",
                "312": "河北",
                "316": "河北",
                "318": "河北",
                "335": "河北",
                "314": "河北",
                "313": "河北",
                "451": "黑龙江",
                "458": "黑龙江",
                "454": "黑龙江",
                "453": "黑龙江",
                "459": "黑龙江",
                "456": "黑龙江",
                "450": "黑龙江",
                "455": "黑龙江",
                "452": "黑龙江",
                "371": "河南",
                "391": "河南",
                "392": "河南",
                "374": "河南",
                "396": "河南",
                "394": "河南",
                "379": "河南",
                "398": "河南",
                "378": "河南",
                "373": "河南",
                "372": "河南",
                "393": "河南",
                "395": "河南",
                "376": "河南",
                "375": "河南",
                "377": "河南",
                "370": "河南",
                "027": "湖北",
                "728": "湖北",
                "712": "湖北",
                "716": "湖北",
                "724": "湖北",
                "711": "湖北",
                "715": "湖北",
                "710": "湖北",
                "719": "湖北",
                "717": "湖北",
                "718": "湖北",
                "713": "湖北",
                "714": "湖北",
                "722": "湖北",
                "731": "湖南",
                "732": "湖南",
                "737": "湖南",
                "730": "湖南",
                "736": "湖南",
                "744": "湖南",
                "738": "湖南",
                "745": "湖南",
                "734": "湖南",
                "739": "湖南",
                "746": "湖南",
                "733": "湖南",
                "748": "湖南",
                "735": "湖南",
                "025": "江苏",
                "511": "江苏",
                "519": "江苏",
                "510": "江苏",
                "512": "江苏",
                "516": "江苏",
                "517": "江苏",
                "527": "江苏",
                "515": "江苏",
                "523": "江苏",
                "513": "江苏",
                "514": "江苏",
                "520": "江苏",
                "518": "江苏",
                "791": "江西",
                "798": "江西",
                "701": "江西",
                "790": "江西",
                "797": "江西",
                "796": "江西",
                "794": "江西",
                "792": "江西",
                "793": "江西",
                "795": "江西",
                "799": "江西",
                "431": "吉林",
                "432": "吉林",
                "433": "吉林",
                "435": "吉林",
                "439": "吉林",
                "434": "吉林",
                "437": "吉林",
                "436": "吉林",
                "438": "吉林",
                "448": "吉林",
                "024": "辽宁",
                "410": "辽宁",
                "413": "辽宁",
                "412": "辽宁",
                "411": "辽宁",
                "414": "辽宁",
                "416": "辽宁",
                "429": "辽宁",
                "421": "辽宁",
                "427": "辽宁",
                "419": "辽宁",
                "417": "辽宁",
                "415": "辽宁",
                "418": "辽宁",
                "471": "内蒙古",
                "479": "内蒙古",
                "478": "内蒙古",
                "477": "内蒙古",
                "470": "内蒙古",
                "476": "内蒙古",
                "482": "内蒙古",
                "475": "内蒙古",
                "474": "内蒙古",
                "472": "内蒙古",
                "473": "内蒙古",
                "951": "宁夏",
                "953": "宁夏",
                "954": "宁夏",
                "952": "宁夏",
                "971": "青海",
                "973": "青海",
                "975": "青海",
                "977": "青海",
                "979": "青海",
                "972": "青海",
                "974": "青海",
                "976": "青海",
                "978": "青海",
                "970": "青海",
                "531": "山东",
                "635": "山东",
                "533": "山东",
                "546": "山东",
                "536": "山东",
                "535": "山东",
                "532": "山东",
                "634": "山东",
                "537": "山东",
                "530": "山东",
                "633": "山东",
                "632": "山东",
                "534": "山东",
                "543": "山东",
                "631": "山东",
                "538": "山东",
                "539": "山东",
                "021": "上海",
                "351": "山西",
                "350": "山西",
                "357": "山西",
                "359": "山西",
                "355": "山西",
                "354": "山西",
                "352": "山西",
                "353": "山西",
                "356": "山西",
                "029": "陕西",
                "911": "陕西",
                "912": "陕西",
                "914": "陕西",
                "916": "陕西",
                "910": "陕西",
                "913": "陕西",
                "915": "陕西",
                "917": "陕西",
                "919": "陕西",
                "028": "四川",
                "834": "四川",
                "838": "四川",
                "835": "四川",
                "825": "四川",
                "819": "四川",
                "817": "四川",
                "832": "四川",
                "831": "四川",
                "810": "四川",
                "837": "四川",
                "833": "四川",
                "812": "四川",
                "816": "四川",
                "839": "四川",
                "811": "四川",
                "818": "四川",
                "826": "四川",
                "813": "四川",
                "830": "四川",
                "022": "天津",
                "991": "新疆",
                "993": "新疆",
                "909": "新疆",
                "901": "新疆",
                "906": "新疆",
                "902": "新疆",
                "997": "新疆",
                "908": "新疆",
                "994": "新疆",
                "992": "新疆",
                "990": "新疆",
                "999": "新疆",
                "995": "新疆",
                "996": "新疆",
                "998": "新疆",
                "903": "新疆",
                "891": "西藏",
                "983": "西藏",
                "895": "西藏",
                "897": "西藏",
                "892": "西藏",
                "894": "西藏",
                "896": "西藏",
                "871": "云南",
                "874": "云南",
                "873": "云南",
                "872": "云南",
                "875": "云南",
                "876": "云南",
                "691": "云南",
                "887": "云南",
                "883": "云南",
                "881": "云南",
                "870": "云南",
                "878": "云南",
                "877": "云南",
                "879": "云南",
                "692": "云南",
                "886": "云南",
                "888": "云南",
                "571": "浙江",
                "575": "浙江",
                "573": "浙江",
                "574": "浙江",
                "580": "浙江",
                "576": "浙江",
                "579": "浙江",
                "570": "浙江",
                "577": "浙江",
                "572": "浙江",
                "578": "浙江",
            },
        }

    def get_provid(self, iccid):
        if not iccid or iccid[:4] != '8986' or \
                not re.match('^[0-9a-fA-F]{9,30}$', iccid):
            # print 'XXX invalid', iccid
            return -2
        try:
            operator = iccid[4:6]
            if operator in ['00', '02', ]:  # CMCC
                _operator = '00'
                provid = iccid[8:10]
            elif operator in ['01']:  # CUC
                _operator = '01'
                provid = iccid[9:11]
            elif operator in ['03', '11']:  # CTC
                _operator = '03'
                provid = iccid[10:13]
            else:
                provid = 'na'
                raise Exception('NOOP')
            return self.prov2pc_map[self.iccid2prov_map[_operator][provid]]
        except Exception as e:
            # from tyframework.context import TyContext
            # TyContext.ftlog.error(iccid, operator, provid, e)
            # print 'XXX', iccid, operator, provid, e
            return -1


IccidLoc = IccidLoc()

if __name__ == '__main__':
    with open('iccids.log') as f:
        for l in f.xreadlines():
            iccid = l[1:-2]
            i = IccidLoc.get_provid(iccid)
            if i > 0:
                print iccid, i
